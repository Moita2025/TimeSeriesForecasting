# 原始数据（`2012-2013 Solar home electricity data v2.csv`）

## 字段描述

| 列号     | 字段                   | 描述                                                                                                                                                 |
| ------ | -------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------- |
| 1      | Customer             | 客户 ID，从 1 到 300                                                                                                                                    |
| 2      | Postcode             | 客户的邮政编码位置                                                                                                                                          |
| 3      | Generator Capacity   | 每个客户连接申请中记录的太阳能板容量。单位为千瓦峰值 (kWp)，这是太阳能板在满太阳辐射和标准条件下测试的峰值功率。                                                                                        |
| 4      | Consumption Category | 两个字母代码，每个表示以下含义：<br>GC = 通用消耗，对于始终供应的电力（主要关税，包括阶梯式或时段费率），不包括太阳能发电和受控负载供应。<br>CL = 受控负载消耗（非高峰 1 或 2 关税）<br>GG = 总发电，对于太阳能系统生成的电力，使用总计量配置，独立于家庭负载测量。 |
| 5      | Date                 | 日期，格式为 DDMMMYYYY。                                                                                                                                  |
| 6      | 0:30                 | 千瓦时 (kWh) 的电能消耗或发电，在结束于 0:30 的半小时内（例如，0:00 到 0:30 之间）。值始终为正，无论消耗还是发电。                                                                              |
| 7 到 53 | 1:00 ... 0:00        | 如上所述，覆盖一天中每个半小时，直到一天的最后一个半小时在 0:00（例如，23:30 到 0:00 之间）。                                                                                            |

## 数据情况概述

形状： (268557, 54)

- 行数：268557
    - 300人，每人平均 895 行，
    - 一天 3 类，每人平均 298 天
- 列数：54

# 预处理方法（`data_preprocess.py`）

## 确定预测目标/目标

**预测任务: 日发电总量预测（e.g., 预测明天GG总和）**

- **y**：特定Customer、次日GG所有时间点的总kWh。
- **X**：
    - 过去几天GG/CL/GC的统计（均值、峰值、总和）。
    - Generator Capacity（直接影响发电上限）。
    - 时间特征：月份（季节影响日照）、预测日的weekday。
    - Postcode（分组客户，捕捉区域差异，如城市 vs 乡村日照）。

## 预处理方法实现

### 主要思想

将原始半小时级宽表 → 每日聚合长表，重点解决**严重缺失日**（>30% 半小时缺失），保证时间连续性和物理合理性，为后续建模提供干净的 `daily_total_kWh`。

### 关键步骤

1. **读取 & 转长表**  
   - 正确解析日期，melt 48 个半小时列 → 半小时级长表（1289 万行）

2. **缺失半小时补齐**  
   - 按 `Customer + Consumption Category` 独立处理  
   - 生成完整 30min 索引，线性插值 + 前后填充

3. **严重缺失日特殊处理（核心创新）**  
   - 统计每日缺失率 > 30% 的天数  
   - 对这些“坏日子”：用**同 weekday + 同时间槽**的历史好日子均值替换（典型 profile）  
   - 已在日志中记录 12 个严重缺失的客户-类别组合（见最上方警告）

4. **日聚合**  
   - 按 Customer/Category/date 求和 → `daily_total_kWh`  
   - 保留 `missing_ratio` 供后续分析  
   - 输出 `data_daily_long.csv`

## 预处理结果

```py
⚠️ 以下客户-类别存在严重缺失日（>30%），已使用同 weekday 同时间槽历史均值插补：
  Customer 2 | Category CL → 81 天
  Customer 2 | Category GC → 81 天
  Customer 2 | Category GG → 81 天
  Customer 68 | Category CL → 65 天
  Customer 161 | Category CL → 59 天
  Customer 187 | Category CL → 58 天
  Customer 248 | Category CL → 45 天
  Customer 272 | Category CL → 65 天
  Customer 284 | Category CL → 65 天
  Customer 289 | Category CL → 60 天
  ... 共 12 个客户-类别组合
```

# 代码全局架构

项目采用 **“树模型单文件 + 深度学习共用工具”** 的双轨设计，便于快速迭代和模型对比。

## 1. `Model_XGBoost.py` —— 完全独立实现

- 所有逻辑（数据加载、特征工程、训练、真实自回归滚动预测）全部写在一个文件里。
- 无外部自定义py代码依赖。

## 2. 深度学习模型系列（`Model_BiLSTM.py`、`Model_AM-BiLSTM.py`、`Model_iTransformer.py` 等）

- **核心通用功能全部抽离到 `Utils_Non_Tree.py`**  
    （数据加载、特征工程、序列构造、训练循环、真实滚动预测、评估指标）
- 每个 `Model_*.py` 只做两件事：
    1. 定义具体的网络结构（BiLSTM、Attention、TPA、CNN-GRU、DNN、iTransformer、KAN 等）
    2. 设置超参数 + 调用 Utils 中的函数

# 深度学习模型通用工具（`Utils_Non_Tree.py`）

## 主要思想

为所有非树模型（RNN、Transformer、CNN、KAN 等）提供**一致的、物理合理的、可复现的**数据准备与评估流程，避免每个模型文件重复编写特征工程、序列构造、训练循环和真实自回归预测逻辑。

核心目标：

- 与 XGBoost 保持尽可能一致的特征体系与切分方式（防泄漏）
- 实现**真正自回归滚动预测**（非 teacher forcing），模拟真实部署场景
- 统一评估指标与后处理（clip、容量上限约束、safe MAPE）

## 关键步骤 / 函数功能一览

1. **`load_daily_data()`**  
    与 `Model_XGBoost.py` 保持完全相同，直接读取预处理后的 `data_daily_long.csv`，保证数据源一致性。

2. **`prepare_data()`**  
    特征工程与防泄漏数据集切分（最核心的防作弊环节）  
    - 按 `Customer` 独立切分 train/test（避免跨客户未来信息泄漏）  
    - 添加时间特征：year, month, day, weekday, is_weekend  
    - 按 `Customer + Consumption Category` 分组计算 lag 特征（1~7 天）  
    - 类别特征：OneHotEncoder 只在 train 上 fit（Consumption Category）  
    - 标识特征：LabelEncoder 在 train+test 合并数据上 fit（Customer, Postcode）  
    - 只对连续数值特征（Generator Capacity + lags）进行 MinMaxScaler  
    - 返回用于序列模型的 X_train/X_test（numpy array）和用于滚动预测的 df_test

3. **`create_sequences()` + `TimeSeriesDataset`**  
    将表格数据转换为适合 RNN/Transformer 的滑动窗口序列  
    - 输入：(样本数, features)  
    - 输出：(batch, seq_length=14, features) 的 X 和 (batch, pred_length=1) 的 y  
    - 使用 PyTorch Dataset 封装，支持 DataLoader shuffle 与多线程加载

4. **`train_model()`**  
    通用 PyTorch 训练循环（适用于几乎所有时序预测模型）  
    - Adam 优化器 + MSE 损失  
    - 带 early stopping（基于验证集损失）  
    - 梯度裁剪（grad_clip=1.0）防止爆炸  
    - 自动保存验证集最优模型权重  
    - 打印每个 epoch 的 train/val loss，便于监控

5. **`rolling_forecast_and_evaluate()`**  
    **真实自回归单步滚动预测与评估**（项目中最关键的公平对比函数）  
    - 从测试集开头取 seq_length 天真实数据作为初始输入  
    - 每次只预测下一天（forecast_horizon=1）  
    - 预测值（scaled）立即用于更新序列中的 lag_1 位置  
    - 序列整体向前滚动一位（最旧一天被挤出，最新的预测值进入）  
    - 其他非 lag 特征（时间特征、容量、编码等）直接从 df_test 取真实值  
    - 后处理：  
        - inverse transform 还原真实尺度  
        - clip 下限 0  
        - clip 上限 ≈ Generator Capacity × 8 小时（物理合理约束）  
    - 计算 MAE / RMSE / safe-MAPE（分母加小 epsilon 防止除 0）  
    - 输出预测与真实的统计信息（min/mean/max），便于诊断偏倚与分布差异

# 实验结果（2026-02-06）

**实际分布**

```py
Actual  stats: min=0.000, mean=9.362, max=104.769
```

**结果表格**

| 模型              | MAE (kWh)  | RMSE (kWh)  | MAPE (safe)  | Predict min / mean / max | 备注 |
|-------------------|-------------|--------------|---------------|---------------------------|------|
| **XGBoost**       | **3.4732**  | **6.7051**   | **44.74%**    | 0.266 / 7.422 / 58.900   | 目前最优 |
| BiLSTM            | 6.5693      | 8.8686       | 203.00%       | 8.000 / 9.268 / 10.514   | - |
| AM-BiLSTM         | 7.0463      | 9.0486       | 233.32%       | 8.000 / 10.674 / 32.000  | - |
| TPA-BiLSTM        | 6.6296      | 8.8725       | 207.81%       | 8.000 / 9.498 / 10.418   | - |
| CNN_GRU           | 6.6423      | 8.8729       | 208.91%       | 8.000 / 9.543 / 11.081   | - |
| DNN               | 8.4938      | 11.0326      | 288.96%       | 8.000 / 13.147 / 45.685  | - |
| **iTransformer**  | 6.6973      | 8.9870       | 207.95%       | **0.000** / 9.575 / 24.000 | 能输出 0 |
| KAN (标准)     | -      | -      | -      | -  | 训练时间极慢，放弃 |
| KAN (2层)     | 8.6792      | 11.6269      | 292.37%       | 8.000 / 13.345 / 79.920  | - |
